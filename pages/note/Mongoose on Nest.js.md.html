<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Mongoose on Nest.js | 906bc906</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Mongoose on Nest.js" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="https://docs.nestjs.com/techniques/mongodb" />
<meta property="og:description" content="https://docs.nestjs.com/techniques/mongodb" />
<link rel="canonical" href="https://906bc906.github.io/jekyll-blog/pages/note/Mongoose%20on%20Nest.js.md" />
<meta property="og:url" content="https://906bc906.github.io/jekyll-blog/pages/note/Mongoose%20on%20Nest.js.md" />
<meta property="og:site_name" content="906bc906" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-11-15T15:47:15+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Mongoose on Nest.js" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-11-22T20:09:22+09:00","datePublished":"2022-11-15T15:47:15+09:00","description":"https://docs.nestjs.com/techniques/mongodb","headline":"Mongoose on Nest.js","mainEntityOfPage":{"@type":"WebPage","@id":"https://906bc906.github.io/jekyll-blog/pages/note/Mongoose%20on%20Nest.js.md"},"url":"https://906bc906.github.io/jekyll-blog/pages/note/Mongoose%20on%20Nest.js.md"}</script>
<!-- End Jekyll SEO tag -->


<meta
  name="keywords"
  content="" />

<link rel="shortcut icon" href="/jekyll-blog/favicon.ico" />
<link rel="apple-touch-icon" href="/jekyll-blog/favicon.ico" />
<link
  rel="alternate"
  type="application/rss+xml"
  title="906bc906 - Second, and Public brain of 906bc906"
  href="/jekyll-blog/feed.xml" />
<link
  rel="stylesheet"
  type="text/css"
  href="/jekyll-blog/assets/css/base.css" />
<link
  rel="stylesheet"
  type="text/css"
  href="/jekyll-blog/assets/css/highlight.css" />

<!--[if lt IE 9]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->


<script
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"
  async>
</script>


<script src="/jekyll-blog/assets/scripts/jekyllpaper.js" async></script>
<script defer src="/jekyll-blog/assets/scripts/img-remove-md.js"></script>
<script
  src="https://unpkg.com/mermaid@8.5.1/dist/mermaid.min.js"
  onload="javascript:loadMermaid();"
  async>
</script>


  </head>
  <body>
    <div class="container-wrapper">
      <header class="container-header">
        <div class="header-info">
  <span class="header-info-name">906bc906</span>
  <span class="header-info-desc">Second, and Public brain of 906bc906</span>
</div>
<nav class="header-nav">
  <ul class="header-main-nav">
    
    <li class="header-main-nav-item">
      <a href="/jekyll-blog/">
        
          All posts
        
      </a>
    </li>
    
    <li class="header-main-nav-item">
      <a href="/jekyll-blog/pages/note/메인%20Main.md">
        
          Index
        
      </a>
    </li>
    
    <li class="header-main-nav-item">
      <a href="/jekyll-blog/feed/pages.xml">
        
          RSS
        
      </a>
    </li>
    
  </ul>
</nav>

      </header>
      <main class="container-main">
        <article class="container-post">
  <div class="post-title">
    <h1>Mongoose on Nest.js</h1>
  </div>
  <div class="post-info">
    <div class="post-date">
      작성일
      2022-11-15 15:47 +09:00
      <br/>
      
        수정일
        2022-11-22 20:09 +09:00
      
    </div>
  </div>
  <ol id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#mongoosemodule">MongooseModule</a></li>
<li class="toc-entry toc-h2"><a href="#model-injection">Model Injection</a>
<ol>
<li class="toc-entry toc-h3"><a href="#schema">Schema</a>
<ol>
<li class="toc-entry toc-h4"><a href="#section">스키마 정의</a></li>
</ol>
</li>
</ol>
</li>
</ol>
  <hr>
  
  <div class="post-author print-post-author">
    <span>906bc906</span>
  </div>
  
  <div class="post-content">
    <p><a href="https://docs.nestjs.com/techniques/mongodb">https://docs.nestjs.com/techniques/mongodb</a></p>
<p><a href="https://www.youtube.com/watch?v=hvbIGDlrGJk">https://www.youtube.com/watch?v=hvbIGDlrGJk</a></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm i @nestjs/mongoose mongoose
</code></pre></div></div>
<p>MongoDB는 <a href="https://docs.nestjs.com/techniques/database">Nest.js 내장 TypeORM 모듈을 사용</a>해도 되지만, 이 글은 mongoose를 사용하는 방법을 다룸.</p>
<h2 id="mongoosemodule">MongooseModule</h2>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//app.module.ts</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Module</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/common</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">MongooseModule</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/mongoose</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span><span class="nx">MongooseModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">(</span><span class="dl">'</span><span class="s1">mongodb://localhost/nest</span><span class="dl">'</span><span class="p">)],</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppModule</span> <span class="p">{}</span>
</code></pre></div></div>
<p>루트 모듈에 <code>MongooseModule</code> import.</p>
<h2 id="model-injection">Model Injection</h2>
<h3 id="schema">Schema</h3>
<p>Mongoose는 모든 것이 <code>Schema</code>에서 파생됨.</p>
<p>각 스키마가 MongoDB Collection 에 매핑되고 해당 Collection의 문서들의 모양을 정의함.</p>
<h4 id="section">스키마 정의</h4>
<pre><code>import { Prop, Schema, SchemaFactory } from '@nestjs/mongoose';
import { HydratedDocument } from 'mongoose';

export type CatDocument = HydratedDocument&lt;Cat&gt;;

@Schema()
export class Cat {
  @Prop()
  name: string;

  @Prop()
  age: number;

  @Prop()
  breed: string;
}

export const CatSchema = SchemaFactory.createForClass(Cat);
</code></pre>
<p><code>@Schema</code> 데코레이터를 붙여 클래스를 스키마 정의로 마크할 수 있다. <code>Cat</code> 클래스를 같은 이름의 MongoDB 컬렉션으로 매핑하나, 뒤에 <code>s</code> 가 붙는다. 즉, 위 코드의 <code>Cat</code> 클래스(로부터 파생된 스키마)는 MongoDB에서 <code>Cats</code> 라는 이름의 컬렉션으로 이어진다.</p>
<p><code>@Schema</code> 데코레이터에는 옵션을 붙일 수 있으며 <a href="https://mongoosejs.com/docs/guide.html#options">이 게시글</a> 참고.</p>
<p><code>@Prop()</code> 데코레이터로 Property를 정의할 수 있다. 타입스크립트 덕분에 추론할 수 있지만 Nested Object 같은 경우 아래와 같이 명시적으로 기재할 수 있다.</p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Prop</span><span class="p">([</span><span class="nb">String</span><span class="p">])</span>
<span class="nx">tags</span><span class="p">:</span> <span class="kr">string</span><span class="p">[];</span>
</code></pre></div></div>
<p>스키마 데코레이터에도 여러 가지 옵션을 붙일 수 있는데, <a href="https://mongoosejs.com/docs/schematypes.html#schematype-options">이 게시글</a> 참고.</p>
<p>다른 모델과의 관계도 명시할 수 있다.</p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">mongoose</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">mongoose</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Owner</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../owners/schemas/owner.schema</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// inside the class definition</span>
<span class="p">@</span><span class="nd">Prop</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span> <span class="na">ref</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Owner</span><span class="dl">'</span> <span class="p">})</span>
<span class="nx">owner</span><span class="p">:</span> <span class="nx">Owner</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Prop</span><span class="p">({</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="nx">name</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
</code></pre></div></div>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Module</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/common</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">MongooseModule</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/mongoose</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">CatsController</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./cats.controller</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">CatsService</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./cats.service</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Cat</span><span class="p">,</span> <span class="nx">CatSchema</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./schemas/cat.schema</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span><span class="nx">MongooseModule</span><span class="p">.</span><span class="nx">forFeature</span><span class="p">([{</span> <span class="na">name</span><span class="p">:</span> <span class="nx">Cat</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="na">schema</span><span class="p">:</span> <span class="nx">CatSchema</span> <span class="p">}])],</span>
  <span class="na">controllers</span><span class="p">:</span> <span class="p">[</span><span class="nx">CatsController</span><span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">CatsService</span><span class="p">],</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">CatsModule</span> <span class="p">{}</span>
</code></pre></div></div>
<p><code>MongooseModule</code> 은 <code>forFeature()</code> 메소드를 제공하는데, 현재 스코프에 어떤 모델들이 등록되어야 하는지 정의하는 것을 포함하여 모듈에 설정할 수 있다.</p>
<p>다른 모듈에서도 모델을 사용하고 싶다면 현재 모듈의 <code>exports</code> 섹션에 <code>CatsModule</code>을 추가하고 다른 모듈에 <code>CatsModule</code>을 import하라.</p>
<p>스키마를 등록했으니 <code>@InjectModel()</code> 데코레이터를 이용하여 <code>Cat</code> 모델을 <code>CatsService</code>에 주입할 수 있다.</p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Model</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">mongoose</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/common</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">InjectModel</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/mongoose</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Cat</span><span class="p">,</span> <span class="nx">CatDocument</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./schemas/cat.schema</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">CreateCatDto</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./dto/create-cat.dto</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">CatsService</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(@</span><span class="nd">InjectModel</span><span class="p">(</span><span class="nx">Cat</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="k">private</span> <span class="nx">catModel</span><span class="p">:</span> <span class="nx">Model</span><span class="o">&lt;</span><span class="nx">CatDocument</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">async</span> <span class="nx">create</span><span class="p">(</span><span class="nx">createCatDto</span><span class="p">:</span> <span class="nx">CreateCatDto</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Cat</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">createdCat</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">catModel</span><span class="p">(</span><span class="nx">createCatDto</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">createdCat</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">findAll</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Cat</span><span class="p">[]</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">catModel</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">exec</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@nestjs/common</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">InjectModel</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/mongoose</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Board</span><span class="p">,</span> <span class="nx">BoardDocument</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./board.schema</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Model</span><span class="p">,</span> <span class="nx">FilterQuery</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">mongoose</span><span class="dl">"</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">BoardRepository</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(@</span><span class="nd">InjectModel</span><span class="p">(</span><span class="nx">Board</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="k">private</span> <span class="nx">boardModel</span><span class="p">:</span> <span class="nx">Model</span><span class="o">&lt;</span><span class="nx">BoardDocument</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">async</span> <span class="nx">findOne</span><span class="p">(</span><span class="nx">userFilterQuery</span><span class="p">:</span> <span class="nx">FilterQuery</span><span class="o">&lt;</span><span class="nx">Board</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Board</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">boardModel</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">userFilterQuery</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">findOneAndUpdate</span><span class="p">(</span><span class="nx">userFilterQuery</span><span class="p">:</span> <span class="nx">FilterQuery</span><span class="o">&lt;</span><span class="nx">Board</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">board</span><span class="p">:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">Board</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Board</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">boardModel</span><span class="p">.</span><span class="nx">findOneAndUpdate</span><span class="p">(</span><span class="nx">userFilterQuery</span><span class="p">,</span> <span class="nx">board</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

  </div>
  <hr>
  
    
<script src="https://giscus.app/client.js"
        data-repo="906bc906/jekyll-blog"
        data-repo-id="R_kgDOIKfIuQ"
        data-category="Comment"
        data-category-id="DIC_kwDOIKfIuc4CR3ta"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="0"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="ko"
        crossorigin="anonymous"
        async>
</script>

  
</article>

      </main>
      <footer class="container-footer">
        <div class="footer-copyright">
  <span class="footer-copyright-text float-left">
    Copyright &copy; 2022. 906bc906.
  </span>
  <span class="footer-copyright-text float-right">
    Powered by <a href="https://jekyllrb.com/">Jekyll</a>, themed by <a href="https://github.com/ghosind/Jekyll-Paper-Github">Jekyll-Paper-Github</a>.
  </span>
</div>

      </footer>
    </div>
  </body>
</html>
