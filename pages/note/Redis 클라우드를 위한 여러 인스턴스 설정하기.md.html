<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Redis 클라우드를 위한 여러 인스턴스 설정하기 | 906bc906</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Redis 클라우드를 위한 여러 인스턴스 설정하기" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="MySQL을 한 클라우드 인스턴스에서 개발용, 프로덕션용으로 나눴다. Redis도 마찬가지의 작업을 하려고 한다. 모든 작업은 우분투 18.04 기준임." />
<meta property="og:description" content="MySQL을 한 클라우드 인스턴스에서 개발용, 프로덕션용으로 나눴다. Redis도 마찬가지의 작업을 하려고 한다. 모든 작업은 우분투 18.04 기준임." />
<link rel="canonical" href="https://906bc906.github.io/jekyll-blog/pages/note/Redis%20%ED%81%B4%EB%9D%BC%EC%9A%B0%EB%93%9C%EB%A5%BC%20%EC%9C%84%ED%95%9C%20%EC%97%AC%EB%9F%AC%20%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4%20%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0.md" />
<meta property="og:url" content="https://906bc906.github.io/jekyll-blog/pages/note/Redis%20%ED%81%B4%EB%9D%BC%EC%9A%B0%EB%93%9C%EB%A5%BC%20%EC%9C%84%ED%95%9C%20%EC%97%AC%EB%9F%AC%20%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4%20%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0.md" />
<meta property="og:site_name" content="906bc906" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-10-25T20:21:55+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Redis 클라우드를 위한 여러 인스턴스 설정하기" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-11-22T20:09:21+09:00","datePublished":"2022-10-25T20:21:55+09:00","description":"MySQL을 한 클라우드 인스턴스에서 개발용, 프로덕션용으로 나눴다. Redis도 마찬가지의 작업을 하려고 한다. 모든 작업은 우분투 18.04 기준임.","headline":"Redis 클라우드를 위한 여러 인스턴스 설정하기","mainEntityOfPage":{"@type":"WebPage","@id":"https://906bc906.github.io/jekyll-blog/pages/note/Redis%20%ED%81%B4%EB%9D%BC%EC%9A%B0%EB%93%9C%EB%A5%BC%20%EC%9C%84%ED%95%9C%20%EC%97%AC%EB%9F%AC%20%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4%20%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0.md"},"url":"https://906bc906.github.io/jekyll-blog/pages/note/Redis%20%ED%81%B4%EB%9D%BC%EC%9A%B0%EB%93%9C%EB%A5%BC%20%EC%9C%84%ED%95%9C%20%EC%97%AC%EB%9F%AC%20%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4%20%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0.md"}</script>
<!-- End Jekyll SEO tag -->


<meta
  name="keywords"
  content="" />

<link rel="shortcut icon" href="/jekyll-blog/favicon.ico" />
<link rel="apple-touch-icon" href="/jekyll-blog/favicon.ico" />
<link
  rel="alternate"
  type="application/rss+xml"
  title="906bc906 - Second, and Public brain of 906bc906"
  href="/jekyll-blog/feed.xml" />
<link
  rel="stylesheet"
  type="text/css"
  href="/jekyll-blog/assets/css/base.css" />
<link
  rel="stylesheet"
  type="text/css"
  href="/jekyll-blog/assets/css/highlight.css" />

<!--[if lt IE 9]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->


<script
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"
  async>
</script>


<script src="/jekyll-blog/assets/scripts/jekyllpaper.js" async></script>
<script defer src="/jekyll-blog/assets/scripts/img-remove-md.js"></script>
<script
  src="https://unpkg.com/mermaid@8.5.1/dist/mermaid.min.js"
  onload="javascript:loadMermaid();"
  async>
</script>


  </head>
  <body>
    <div class="container-wrapper">
      <header class="container-header">
        <div class="header-info">
  <span class="header-info-name">906bc906</span>
  <span class="header-info-desc">Second, and Public brain of 906bc906</span>
</div>
<nav class="header-nav">
  <ul class="header-main-nav">
    
    <li class="header-main-nav-item">
      <a href="/jekyll-blog/">
        
          All posts
        
      </a>
    </li>
    
    <li class="header-main-nav-item">
      <a href="/jekyll-blog/pages/note/메인%20Main.md">
        
          Index
        
      </a>
    </li>
    
    <li class="header-main-nav-item">
      <a href="/jekyll-blog/feed/pages.xml">
        
          RSS
        
      </a>
    </li>
    
  </ul>
</nav>

      </header>
      <main class="container-main">
        <article class="container-post">
  <div class="post-title">
    <h1>Redis 클라우드를 위한 여러 인스턴스 설정하기</h1>
  </div>
  <div class="post-info">
    <div class="post-date">
      작성일
      2022-10-25 20:21 +09:00
      <br/>
      
        수정일
        2022-11-22 20:09 +09:00
      
    </div>
  </div>
  <ol id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#section">하려는 것</a></li>
<li class="toc-entry toc-h2"><a href="#section-1">사전 지식</a></li>
<li class="toc-entry toc-h2"><a href="#section-2">인스턴스 추가 생성</a>
<ol>
<li class="toc-entry toc-h3"><a href="#conf-">conf 복제</a></li>
<li class="toc-entry toc-h3"><a href="#conf--1">conf 세팅</a></li>
<li class="toc-entry toc-h3"><a href="#conf--">conf 소유자 세팅</a></li>
<li class="toc-entry toc-h3"><a href="#working-directory-">working directory 생성</a></li>
<li class="toc-entry toc-h3"><a href="#init-script----">서비스 init script 파일 찾기 및 복제</a></li>
</ol>
</li>
<li class="toc-entry toc-h2"><a href="#auth---bind--">auth 등록 및 bind 주소 변경</a>
<ol>
<li class="toc-entry toc-h3"><a href="#user-">패스워드를 사용하는 USER 등록</a></li>
<li class="toc-entry toc-h3"><a href="#bind--">bind 주소 변경</a></li>
<li class="toc-entry toc-h3"><a href="#section-3">재시작</a></li>
</ol>
</li>
</ol>
  <hr>
  
  <div class="post-author print-post-author">
    <span>906bc906</span>
  </div>
  
  <div class="post-content">
    <p>MySQL을 한 클라우드 인스턴스에서 개발용, 프로덕션용으로 나눴다. Redis도 마찬가지의 작업을 하려고 한다. 모든 작업은 우분투 18.04 기준임.</p>
<h2 id="section">하려는 것</h2>
<p>ncloud 인스턴스 하나에 Redis 인스턴스를 두 개를 만든다.</p>
<p>한 인스턴스는 로컬에서만 접근 가능하고, 다른 인스턴스는 외부에서 접근 가능하게 할 것이다.</p>
<p>외부에서 접근 가능한 인스턴스는 유저이름과 비밀번호로 식별할 것이다.</p>
<h2 id="section-1">사전 지식</h2>
<p>Redis는 기본적으로 식별 수단이 설정되어 있지 않다.</p>
<p>따라서 아무런 식별 수단 없이 외부에 노출하면 보안에 치명적이다.</p>
<p>또한 유저이름과 비밀번호로 식별한다 하더라도 고성능인 Redis 특성 상 병렬로 무작위 공격을 할 수 있으므로 비밀번호는 매우 길게 설정해야 한다.<sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup></p>
<p><code>/etc/redis/redis.conf</code> 에서 다양한 것들을 설정할 수 있다.</p>
<p>redis는 한 인스턴스에서 넘버로 식별되는 여러 데이터베이스를 사용할 수 있다. 기본적으로는 16개로 세팅이 되어있다. <code>db-number</code>를 <code>select</code> 명령어를 통해 지정할 수 있다.</p>
<p>하지만 db-number 단위로 bind-address를 수정할 수 없다. (적어도 내가 알기론) 따라서 개발용, 프로덕션용 인스턴스를 따로 만들 것이다.</p>
<h2 id="section-2">인스턴스 추가 생성</h2>
<p>참조한 사이트들</p>
<ul>
<li><a href="https://gist.github.com/Paprikas/ef55f5b2401c4beec75f021590de6a67">How to run multiple Redis instances on Ubuntu 18.04</a></li>
<li><a href="https://www.bogotobogo.com/DevOps/Redis/Redis_Setting_up_mulitple_server_instances_on_a_linux_host.php">Redis - Setting up multiple server instances on a Linux host - 2020</a></li>
<li><a href="https://gist.github.com/akhdaniel/04e4bb2df76ef534b0cb982c1dc6225b">run multiple redis instances on the same server for centos</a></li>
<li><a href="https://hellomyblog.tistory.com/9">multiple Redis server instances on a Linux host</a></li>
</ul>
<h3 id="conf-">conf 복제</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /etc/redis
<span class="nb">cp </span>redis.conf redis.dev.conf
</code></pre></div></div>
<h3 id="conf--1">conf 세팅</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano redis.dev.conf
</code></pre></div></div>
<p>변경해야 하는 것</p>
<ul>
<li>port</li>
<li>pidfile</li>
<li>logfile</li>
<li>dir</li>
</ul>
<p>추가로, 이후에 사용자를 등록하고 이를 파일로 저장하여 관리하고 싶다면 <code>aclfile</code> 항목을 주석 제거해야 한다.</p>
<pre><code># aclfile /etc/redis/users.acl
</code></pre>
<p>대충 이런 느낌으로 있을 건데, <code>#</code> 제거하여 주석 해제하고 실제로 해당 경로에 <code>acl</code> 파일을 <strong>반드시 빈 파일로라도 만들어둬야</strong> 한다.</p>
<p><code>aclfile</code>로 지정한 파일이 없으면 레디스 서버 실행이 안 된다.</p>
<pre><code>touch /etc/redis/users.acl
</code></pre>
<h3 id="conf--">conf 소유자 세팅</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo chown </span>redis:redis /etc/redis/redis.dev.conf
</code></pre></div></div>
<h3 id="working-directory-">working directory 생성</h3>
<p>conf 세팅할 때 dir로 지정했던 경로를 만들어야 함.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> /var/lib/redis-dev
<span class="nb">sudo chown </span>redis:redis /var/lib/redis-dev
</code></pre></div></div>
<h3 id="init-script----">서비스 init script 파일 찾기 및 복제</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find / <span class="nt">-name</span> <span class="s2">"*redis*service*"</span>
</code></pre></div></div>
<p>대충 <code>/usr/lib/systemd/system/redis-server.service</code> 이런 경로를 찾을 수 있다. 내 경우에는 <code>/lib/systemd/system/redis-server.service</code> 였다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo cp</span> /lib/systemd/system/redis-server.service /lib/systemd/system/redis-dev-server.service
</code></pre></div></div>
<p>이후</p>
<pre><code>...
ExecStart=/usr/bin/redis-server /etc/redis/redis.dev.conf
...
PIDFile=/run/redis/redis-dev-server.pid
...
RuntimeDirectory=redis-dev
...
ReadWriteDirectories=-/var/lib/redis-dev
...
Alias=redis.dev.service
</code></pre>
<p>이 정도 수정하고 <code>sudo systemctl start redis-dev-server</code> 로 실행했다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>redis-cli <span class="nt">-p</span> &lt;새 포트번호&gt;
</code></pre></div></div>
<p>로 접속을 확인할 수 있다.</p>
<p>뭔 짓을 해도 connection refused 가 안 돼서 3시간 가량 찾아봤는데 bind 주소가 127.0.0.1이 아니라 127.0.0.7 로 적혀있어서 생긴 문제였다. 127과 포트만 봤지 0.7로 끝난다곤 상상도 못 했다. 대체 뭐하다가 저게 바뀐건지..</p>
<h2 id="auth---bind--">auth 등록 및 bind 주소 변경</h2>
<h3 id="user-">패스워드를 사용하는 USER 등록</h3>
<p><a href="https://redis.io/docs/manual/security/acl/">ACL | Redis</a></p>
<p><a href="https://redis.io/commands/auth/">AUTH | Redis</a></p>
<p>처음에 언급했듯 redis의 비밀번호는 가능한 길게 설정해주는 것이 좋다. 비밀번호를 생성하기 위해 redis <code>ACL</code> 의 <code>GENPASS</code> 기능을 이용하자.</p>
<pre><code>127.0.0.1:6389&gt; ACL GENPASS
&quot;90143be03110fa323e7bec30183b1d57c8d57b5f203a4ff438537b044990fabf&quot;
</code></pre>
<p>생성된 비밀번호로 계정을 생성한다.</p>
<pre><code>127.0.0.1:6389&gt; ACL SETUSER &lt;아이디&gt; on &gt;&lt;비밀번호&gt; ~* &amp;* +@all
OK
</code></pre>
<p>예를 들어, 아래와 같이 작성한다.</p>
<pre><code>127.0.0.1:6389&gt; ACL SETUSER david on &gt;90143be03110fa323e7bec30183b1d57c8d57b5f203a4ff438537b044990fabf ~* &amp;* +@all
OK
</code></pre>
<p><code>~*</code> 는 모든 키, <code>&amp;*</code> 는 모든 하위 채널, <code>+@all</code> 는 모든 명령을 의미한다. 디테일하게 허가하고 싶다면 <a href="https://redis.io/docs/manual/security/acl/">ACL | Redis</a>의 ACL 규칙 항목을 참고하면 된다.</p>
<pre><code>127.0.0.1:6389&gt; ACL LIST
1) &quot;user default on nopass ~* &amp;* +@all&quot;
2) &quot;user &lt;아이디&gt; on #&lt;비밀번호 해쉬&gt; ~* &amp;* +@all&quot;
</code></pre>
<p><code>ACL LIST</code> 로 계정이 생성되었는지 확인한다.</p>
<p>패스워드 없이 로그인할 수 있는 <code>default</code> 계정을 제거하고 싶지만 정책상 <code>default</code> 계정은 제거할 수 없다.<sup class="footnote-ref"><a href="#fn2" id="fnref2">2</a></sup></p>
<p><code>default</code> 계정으로 인증할 수 없도록 비활성화하는 정도가 최선.</p>
<pre><code>127.0.0.1:6389&gt; ACL SETUSER default off
OK
</code></pre>
<p>기존 연결된 커넥션은 유지되기 때문에 새로 <code>redis-cli</code> 를 실행하면 <code>AUTH</code> 없이는 어떠한 명령어도 실행할 수 없는 것을 확인할 수 있다.</p>
<p>참고로, <a href="https://redis.io/docs/manual/security/#protected-mode">protected mode</a> 가 활성화되어있을 때(기본으로 활성화되어있다), default 계정이 <code>nopass</code>인 경우, 원격 접속을 차단하고 루프백 인터페이스로만 동작한다. 따라서 <strong>protection mode를 끄지 않았다면 default 유저를 사용하지 않더라도 패스워드는 지정해줘야</strong> 한다.</p>
<p>ACLFILE을 저장하도록 설정을 했다면 ACL을 편집하고 나서 <code>ACL SAVE</code> 로 저장해야 한다.</p>
<p>redis-cli 진입 후 AUTH는 <code>AUTH &lt;아이디&gt; &lt;비밀번호&gt;</code> 의 형식으로 진행하면 된다.</p>
<h3 id="bind--">bind 주소 변경</h3>
<p><code>redis.conf</code> (또는 복사한 conf 파일) 에서 <code>bind</code> 를 수정하면 된다.</p>
<p>내 경우 모든 ipv4 에 대해서 허용하기 위해 <code>bind *</code> 로 설정했다.</p>
<p>ipv6은 <code>-::*</code> 로 지정하는듯.</p>
<h3 id="section-3">재시작</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl stop &lt;레디스 서비스 명&gt;
<span class="nb">sudo </span>systemctl start &lt;레디스 서비스 명&gt;
</code></pre></div></div>
<p>아까 <code>redis-server.service</code> 를 복사해뒀던 파일명이 서비스 명이다. 내 경우엔 <code>redis-dev-server.service</code>, 확장자는 생략해도 괜찮다.</p>
<p>원격으로 redis cli 접속이 정상적으로 동작하는 것을 확인했다.</p>
<section class="footnotes">
<ol>
<li id="fn1">
<p><a href="https://redis.io/commands/auth/">AUTH | Redis</a> <a href="#fnref1" class="footnote-backref">↩</a></p>
</li>
<li id="fn2">
<p><a href="https://redis.io/commands/acl-deluser/">ACL DELUSER | Redis</a> <a href="#fnref2" class="footnote-backref">↩</a></p>
</li>
</ol>
</section>

  </div>
  <hr>
  
    
<script src="https://giscus.app/client.js"
        data-repo="906bc906/jekyll-blog"
        data-repo-id="R_kgDOIKfIuQ"
        data-category="Comment"
        data-category-id="DIC_kwDOIKfIuc4CR3ta"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="0"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="ko"
        crossorigin="anonymous"
        async>
</script>

  
</article>

      </main>
      <footer class="container-footer">
        <div class="footer-copyright">
  <span class="footer-copyright-text float-left">
    Copyright &copy; 2022. 906bc906.
  </span>
  <span class="footer-copyright-text float-right">
    Powered by <a href="https://jekyllrb.com/">Jekyll</a>, themed by <a href="https://github.com/ghosind/Jekyll-Paper-Github">Jekyll-Paper-Github</a>.
  </span>
</div>

      </footer>
    </div>
  </body>
</html>
